# Syrup
[![License: GPL v3](https://img.shields.io/badge/License-GPLv3-blue.svg)](https://github.com/costa-group/gasol-optimizer/blob/main/LICENSE)
![version](https://img.shields.io/badge/version-2.0-green)

`Syrup` is a tool that applies super-optimization techniques to optimize Ethereum's smart contracts. In order to do so, `Syrup`
splits smart contracts into basic block, and for each of them, tries to find a sequence of EVM instructions that leads to the same stack
as the original block but spends less gas. 

`Syrup` uses an intermediate representation (Stack Functional
Specification or SFS) on the impact a sequence of instructions has on
a block, and from this representation, a Max-SMT encoding is derived
to find the best translation. The SFS defines the state of the stack
after executing the basic block in terms of the state of the initial stack.

This version of the `syrup` tool is implemented entirely in Python3 and considers further configurations in the Max-SMT encoding
to determine the best options for its usage.

## Installation (Ubuntu 20.04)

### 1. Install Solidity compiler (last version tested 0.8.1)

The folder ethir/source contains static executables of different
versions of Solidity compiler. Add it to the PATH and test that it is
installed.
    
```
 sudo cp source/solc* /usr/bin/
 sudo chmod 755 /usr/bin/solc*
 solc --version
 solcv5 --version
 solcv6 --version
 solcv7 --version
 solcv8 --version
 ```
 
In case you want to install the latest version:
 
 ```
 sudo add-apt-repository ppa:ethereum/ethereum
 sudo apt-get update
 sudo apt-get install solc
```

### 2. Install Ethereum (last version tested 1.9.20)

Static executables of the Ethereum Virtual Machine are provided in the
folder source. Add ot to the PATh and test that it is installed.
 
 ```
 sudo cp source/evm* /usr/bin/
 sudo chmod 755 /usr/bin/evm*
 evm --version
 ```
 In case you want to install the latest version:
  
```
 sudo apt-get install software-properties-common
 sudo add-apt-repository -y ppa:ethereum/ethereum
 sudo apt-get update
 sudo apt-get install ethereum
```

### 3. Install [Z3](https://github.com/Z3Prover/z3/releases)

Use `pip install` command to install Z3

```
pip3 install z3
pip3 install z3-solver
```
### 4. Install dependencies

Use `pip install` command to install six and requests python
libraries.

```
pip install six
pip install requests
```

### 5. Install the SMT Solvers

Download an static executable of the SMT solvers used from the
following links:

* Z3: https://github.com/Z3Prover/z3/releases/tag/z3-4.8.12
* Barcelogic: Send an email to alberu04@ucm.es. Subject: "Static
  Executable Syrup".
* OptiMathSAT: http://optimathsat.disi.unitn.it/pages/download-js.html

When they are downloaded, create a directory called bin in the root
directory of the repository and move them to this folder.

## Usage

### Input format

`Syrup 2.0` can take either a Solidity smart contract, EVM bytecode,
an isolated basic block or the SFS of a basic block as input. Examples
are available in the following links:
* Solidity smart contracts: https://github.com/costa-group/syrup-python/tree/master/examples/tosem-benchmarks-a
* EVM bytecode:
  https://github.com/costa-group/syrup-python/tree/master/examples/tosem-benchmarks-b
* Basic block: https://github.com/costa-group/syrup-python/tree/master/examples/basic-blocks
* SFS: https://github.com/costa-group/syrup-python/tree/master/examples/blocks

### Output format

`Syrup 2.0` stores all the output from its execution in the folder
/tmp/syrup/solutions. For each analyzed contract, it creates three
folders in this directory containing all the relevant information for
each optimized sub-block:

* evm: generated bytecode of the solution.

* disasm: opcodes from the solution, in format human-readable.

* total_gas: gas associated to each generated block.


### Max-SMT encoding

`Syrup 2.0` aims to determine the most suitable configuration in order to make the framework feasible to include in _real-world_ compilers. As such, 
there exists several flags that allow the user to specify different combinations of constraints and timeouts. These configurations have been studied in detail and a [visualizer](http://costa.fdi.ucm.es/syrup-visualizer) has been implemented to interpret the experiments.

By default, the encoding that has been determined to work the best so far is enabled. It can be disabled using -disable-default-encoding flag :

```
TODO
```

When disabled, the same encoding as `Syrup 1.0` is produced by default: O'<sub>SFS</sub> + C<sub>L</sub>. The following flags activate different constraints to be included:

* -inequality-gas-model : change soft constraint encoding from O'<sub>SFS</sub> to O<sub>SFS</sub> 
* -pushed-once : enable hard constraint _Numerical values pushed at least once_ or C<sub>N</sub> 
* -no-output-before-pop : enable hard constraint _Restricted opcodes before POP_ or C<sub>R</sub> 
* -at-most : enable hard constraint _Uninterpreted opcodes at most once_ or C<sub>U</sub>

Other flags can be enabled to add other hard constraints or modify the soft constraints. However, they have not been fully checked and it is not guaranteed the produced blocks are indeed equivalent to the initial ones.

The timeout per block can be specified using -tout flag. It is set to 10 seconds by default. When the timeout is reached, the underlying SMT solver halts its execution and returns the best
model so far. If no model was found, no final block is produced. For instance, using previous example, we could specify a timeout of 5 seconds instead:

### Analyze a smart contract

Execute the following command to analyze a provided smart contract:

```
syrup_full_execution.py -s SOURCE -storage [-b] [-isb] [-json] [-solver
                               {z3,barcelogic,oms}] [-v]
                               [-at-most] [-pushed-once] [-tout
                               timeout] [-inequality-gas-model]
                               [-instruction-order]
                               [-no-output-before-pop]
                               [-initial-solution]
                               [-disable-default-encoding]
                               [-number-instruction-gas-model] 
                               [-disable-generation-log-file] [-check-log-file log_file]
```

where the:
* SOURCE represents the source file where the Solidity smart contract,
EVM bytecode, SFS os basic block is stored
* -b is needed when analyzing EVM bytecode
* -isb is needed when analyzing a basic block
* -json is needed when analyzing a SFS
* -solver allows selecting the desired SMT solver
* -v activates the lightweight verifier included in `Syrup 2.0`
* -tout allows specifying a desired timeout for the optimization
  process of each of the basic blocks of the smart contract under
  analysis. It is set to XXs by default
* ----
* ----
* TODO


For instances, to analyze the smart contract [0x001385C23468Cb4614831aD9205F041Cf64A2958.sol](https://github.com/costa-group/syrup-python/blob/master/examples/tosem-benchmarks-a/0x001385C23468Cb4614831aD9205F041Cf64A2958.sol) using
OptiMathSAT as SMT solver and the default configuration, you have to
execute the following command:
```
./syrup_full_execution.py -s examples/tosem-benchmarks-a/0x001385C23468Cb4614831aD9205F041Cf64A2958.sol -storage -solver oms
```
## How to reproduce the experiments presented in TOSEM

The directory _examples_ contains the benchmarks used in the
experimental section (Section 5) of the paper (directories
_tosem-benchmarks-a_ and _tosem-benchmarks-b_ respectively) submitted
to TOSEM. The smart contracts located in _tosem-benckmarks-a_ are
those selected for experiments (i) and (ii) and the ones located in
_tosem-benckmarks-b_ the contracts used for experiments (iii),

In order to reproduce the results, you can find the scripts used in
the directory _scripts_:

* Script _process\_benckmarks\_a.sh_ (_process\_benckmarks\_b.sh_
respectively) generates the SFS for all the blocks of the smart
contracts located in the directory _tosem-benckmarks-a_ (_tosem-benckamrks b_ respectively).

* To reproduce the results obtained in Section 5.2 and 5.3, you have to 
execute the script XX running the command YY.

* To reproduce the results obtained in Section 5.4, you have to execute the script XX running the command YY.

In addition, to optimize a smart contract you have to execute the
command line XX.  It generates the SFS of all its blocks and, after
that, it generates the optimized blocks using the specified SMT-solver
and timeout.
